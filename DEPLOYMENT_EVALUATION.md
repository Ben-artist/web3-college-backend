# éƒ¨ç½²æ–¹æ¡ˆè¯„ä¼°æŠ¥å‘Š

**è¯„ä¼°æ—¥æœŸ**: 2025-11-04  
**è¯„ä¼°äºº**: AI Assistant  
**é¡¹ç›®**: web3-college-backend

---

## âœ… æ€»ä½“è¯„ä¼°ï¼š**å¯è¡Œï¼Œä½†éœ€è¦ä¿®å¤å‡ ä¸ªé—®é¢˜**

è¿™ä¸ªéƒ¨ç½²æ–¹æ¡ˆæ¶æ„åˆç†ï¼Œä½¿ç”¨ AWS CodePipeline + CodeBuild + Secrets Manager æ˜¯ä¸šç•Œæ ‡å‡†åšæ³•ã€‚æ•´ä½“è®¾è®¡æ€è·¯æ­£ç¡®ï¼Œä½†æœ‰ä¸€äº›é…ç½®éœ€è¦è°ƒæ•´ã€‚

---

## ğŸ“Š æ¶æ„è¯„ä¼°

### âœ… ä¼˜ç‚¹

1. **æ¶æ„è®¾è®¡åˆç†**
   - CodePipeline è‡ªåŠ¨åŒ– CI/CD æµç¨‹
   - CodeBuild æä¾›æ ‡å‡†åŒ–çš„æ„å»ºç¯å¢ƒ
   - Secrets Manager å®‰å…¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯
   - Serverless Framework ç®€åŒ– Lambda éƒ¨ç½²

2. **é…ç½®å®Œæ•´**
   - `buildspec.yml` é…ç½®è¯¦ç»†ä¸”é€»è¾‘æ¸…æ™°
   - `codebuild-project-config.json` ç¯å¢ƒå˜é‡é…ç½®å®Œæ•´
   - `codepipeline-stack.yaml` CloudFormation æ¨¡æ¿å®Œæ•´

3. **å®‰å…¨æ€§è€ƒè™‘**
   - ä½¿ç”¨ Secrets Manager è€Œéç¡¬ç¼–ç å‡­è¯
   - IAM è§’è‰²æƒé™é…ç½®åˆç†

4. **åŒºåŸŸä¸€è‡´æ€§**
   - æ‰€æœ‰é…ç½®ç»Ÿä¸€ä½¿ç”¨ `ap-southeast-1`
   - ä¸é¡¹ç›®å…¶ä»–éƒ¨åˆ†ä¿æŒä¸€è‡´

---

## âš ï¸ å‘ç°çš„é—®é¢˜

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### 1. Handler è·¯å¾„é…ç½®é—®é¢˜

**é—®é¢˜**: `serverless.yml` ä¸­ handler é…ç½®ä¸º `src/lambda.handler`ï¼Œä½†å®é™…ç¼–è¯‘åçš„æ–‡ä»¶åœ¨ `dist/` ç›®å½•ã€‚

**å½“å‰é…ç½®**:
```yaml
handler: src/lambda.handler
```

**é—®é¢˜åˆ†æ**:
- ä½¿ç”¨ `serverless-esbuild` æ’ä»¶æ—¶ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨å¤„ç†ç¼–è¯‘
- ä½†å¦‚æœæ’ä»¶é…ç½®ä¸å½“ï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶æ‰¾ä¸åˆ° handler
- éœ€è¦ç¡®è®¤ `serverless-esbuild` æ˜¯å¦æ­£ç¡®é…ç½®äº†å…¥å£ç‚¹

**å»ºè®®ä¿®å¤**:
```yaml
# æ–¹æ¡ˆ1: å¦‚æœä½¿ç”¨ serverless-esbuildï¼Œä¿æŒ src/lambda.handlerï¼ˆæ’ä»¶ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
# ä½†éœ€è¦ç¡®ä¿æ’ä»¶é…ç½®æ­£ç¡®

# æ–¹æ¡ˆ2: å¦‚æœç›´æ¥ä½¿ç”¨ç¼–è¯‘åçš„æ–‡ä»¶ï¼Œæ”¹ä¸ºï¼š
handler: dist/lambda.handler
```

**éªŒè¯æ–¹æ³•**:
```bash
# æœ¬åœ°æµ‹è¯•éƒ¨ç½²
cd web3-college-backend
pnpm run build
# æ£€æŸ¥ dist/lambda.js æ˜¯å¦å­˜åœ¨
ls -la dist/lambda.js
```

#### 2. Buildspec é…ç½®ä¸ä¸€è‡´

**é—®é¢˜**: éƒ¨ç½²æŒ‡å—ä¸­è¯´æ˜ä½¿ç”¨"å†…è” buildspec"ï¼Œä½†å®é™…é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ˜¯æ–‡ä»¶ `buildspec.yml`ã€‚

**å½“å‰çŠ¶æ€**:
- `codebuild-project-config.json` ä¸­é…ç½®: `"buildspec": "buildspec.yml"`
- `DEPLOYMENT_GUIDE.md` ä¸­è¯´æ˜: "ä½¿ç”¨å†…è” buildspec"

**å»ºè®®**: 
- å¦‚æœä½¿ç”¨æ–‡ä»¶æ–¹å¼ï¼ˆæ¨èï¼Œæ›´æ˜“ç»´æŠ¤ï¼‰ï¼Œéœ€è¦æ›´æ–°éƒ¨ç½²æŒ‡å—
- å¦‚æœä½¿ç”¨å†…è”æ–¹å¼ï¼Œéœ€è¦æ›´æ–° CodeBuild é¡¹ç›®é…ç½®

---

### ğŸŸ¡ éœ€è¦æ³¨æ„çš„é—®é¢˜

#### 3. Lambda Layer æ„å»ºä¾èµ–

**é—®é¢˜**: `buildspec.yml` ä¸­ Lambda Layer æ„å»ºæ˜¯å¯é€‰çš„ï¼ˆ`BUILD_LAYER=false`ï¼‰ï¼Œä½† `serverless.yml` ä¸­é…ç½®äº† Layerï¼š

```yaml
layers:
  - { Ref: NodeModulesLambdaLayer }
```

**å½±å“**:
- å¦‚æœ `BUILD_LAYER=false`ï¼ŒLayer ä¸ä¼šè¢«æ„å»ºï¼Œå¯èƒ½å¯¼è‡´éƒ¨ç½²å¤±è´¥
- æˆ–è€… Layer éœ€è¦åœ¨éƒ¨ç½²å‰æ‰‹åŠ¨æ„å»º

**å»ºè®®**:
1. å¦‚æœä½¿ç”¨ Layerï¼Œåœ¨ `buildspec.yml` ä¸­è®¾ç½® `BUILD_LAYER=true`
2. æˆ–è€…ä¿®æ”¹ `serverless.yml`ï¼Œä½¿ Layer å¯é€‰

#### 4. ç¯å¢ƒå˜é‡ä¼ é€’

**é—®é¢˜**: `serverless.yml` ä¸­ç¯å¢ƒå˜é‡é…ç½®è¾ƒå°‘ï¼Œä¸»è¦ä¾èµ– `.env` æ–‡ä»¶ï¼š

```yaml
environment:
  NODE_OPTIONS: --enable-source-maps
  API_PREFIX: ${env:API_PREFIX, 'api'}
  # å…¶ä»–å˜é‡ä» .env è¯»å–
```

**å½“å‰è§£å†³æ–¹æ¡ˆ**:
- `buildspec.yml` ä» Secrets Manager è¯»å–å¹¶å¯¼å‡ºç¯å¢ƒå˜é‡
- Serverless Framework é€šè¿‡ `serverless-dotenv-plugin` è¯»å– `.env` æ–‡ä»¶

**å»ºè®®**:
- ç¡®ä¿ CodeBuild ç¯å¢ƒä¸­çš„ç¯å¢ƒå˜é‡èƒ½æ­£ç¡®ä¼ é€’åˆ° Serverless éƒ¨ç½²
- æˆ–è€…åœ¨ `serverless.yml` ä¸­æ˜¾å¼é…ç½®å…³é”®ç¯å¢ƒå˜é‡

#### 5. Serverless Framework ç‰ˆæœ¬

**é—®é¢˜**: `serverless.yml` ä¸­é…ç½® `frameworkVersion: '3'`ï¼Œä½† `package.json` ä¸­å¯èƒ½å®‰è£…çš„æ˜¯å…¶ä»–ç‰ˆæœ¬ã€‚

**å»ºè®®éªŒè¯**:
```bash
cd web3-college-backend
pnpm list serverless
```

---

### ğŸŸ¢ å°ä¼˜åŒ–å»ºè®®

#### 6. æ„å»ºæ—¶é—´ä¼˜åŒ–

**å»ºè®®**: åœ¨ `buildspec.yml` ä¸­å¯ç”¨ç¼“å­˜ï¼š

```yaml
cache:
  paths:
    - 'node_modules/**/*'
    - '.pnpm-store/**/*'
```

**å½“å‰çŠ¶æ€**: âœ… å·²é…ç½®

#### 7. é”™è¯¯å¤„ç†

**å»ºè®®**: åœ¨ `buildspec.yml` ä¸­æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡ºã€‚

**å½“å‰çŠ¶æ€**: âœ… å·²æœ‰åŸºæœ¬æ—¥å¿—è¾“å‡º

---

## ğŸ”§ ä¿®å¤å»ºè®®

### ä¼˜å…ˆçº§ 1: å¿…é¡»ä¿®å¤ï¼ˆéƒ¨ç½²å‰ï¼‰

1. **ä¿®å¤ Handler è·¯å¾„**
   - æµ‹è¯• `serverless-esbuild` æ˜¯å¦æ­£ç¡®ç¼–è¯‘
   - å¦‚æœä¸è¡Œï¼Œä¿®æ”¹ä¸º `dist/lambda.handler`

2. **ç»Ÿä¸€ Buildspec é…ç½®**
   - å†³å®šä½¿ç”¨æ–‡ä»¶æ–¹å¼è¿˜æ˜¯å†…è”æ–¹å¼
   - æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œé…ç½®ä¿æŒä¸€è‡´

3. **éªŒè¯ Lambda Layer æ„å»º**
   - æµ‹è¯• `BUILD_LAYER=false` æ—¶æ˜¯å¦èƒ½æ­£å¸¸éƒ¨ç½²
   - å¦‚æœä¸è¡Œï¼Œè®¾ç½®ä¸º `true` æˆ–ä¿®æ”¹ serverless.yml

### ä¼˜å…ˆçº§ 2: å»ºè®®ä¿®å¤ï¼ˆéƒ¨ç½²åä¼˜åŒ–ï¼‰

1. **æ›´æ–°éƒ¨ç½²æŒ‡å—**
   - ä¿®æ­£ä¸å®é™…é…ç½®ä¸ä¸€è‡´çš„éƒ¨åˆ†
   - è¡¥å……éªŒè¯æ­¥éª¤

2. **æ·»åŠ éƒ¨ç½²éªŒè¯è„šæœ¬**
   - éƒ¨ç½²åè‡ªåŠ¨æµ‹è¯• API ç«¯ç‚¹
   - éªŒè¯ Lambda å‡½æ•°çŠ¶æ€

---

## ğŸ“ æµ‹è¯•æ¸…å•

åœ¨æ­£å¼éƒ¨ç½²å‰ï¼Œå»ºè®®æ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### æœ¬åœ°æµ‹è¯•

- [ ] ç¼–è¯‘æµ‹è¯•: `pnpm run build`
- [ ] æœ¬åœ°éƒ¨ç½²æµ‹è¯•: `pnpm run sls:deploy -- --stage dev`
- [ ] éªŒè¯ Lambda Handler: æ£€æŸ¥ç¼–è¯‘åçš„ `dist/lambda.js` æ˜¯å¦å­˜åœ¨
- [ ] æµ‹è¯• Layer æ„å»º: `pnpm run sls:build-layer`

### CI/CD æµ‹è¯•

- [ ] æ‰‹åŠ¨è§¦å‘ Pipeline æµ‹è¯•
- [ ] éªŒè¯ Secrets Manager è¯»å–
- [ ] éªŒè¯æ„å»ºè¿‡ç¨‹
- [ ] éªŒè¯éƒ¨ç½²æˆåŠŸ
- [ ] æµ‹è¯• API ç«¯ç‚¹å“åº”

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### âœ… å¯ä»¥éƒ¨ç½²ï¼Œä½†éœ€è¦å…ˆä¿®å¤ï¼š

1. **ç«‹å³ä¿®å¤ Handler è·¯å¾„é—®é¢˜**
2. **ç»Ÿä¸€ Buildspec é…ç½®è¯´æ˜**
3. **éªŒè¯ Lambda Layer æ„å»ºæµç¨‹**

### ğŸ“‹ éƒ¨ç½²æ­¥éª¤

1. **ä¿®å¤é…ç½®é—®é¢˜**ï¼ˆè§ä¸Šæ–¹ï¼‰
2. **åˆ›å»º Secrets Manager Secret**ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
3. **åˆ›å»º CodeBuild é¡¹ç›®**ï¼ˆä½¿ç”¨ `codebuild-project-config.json`ï¼‰
4. **åˆ›å»º CodePipeline**ï¼ˆæˆ–ä½¿ç”¨ `codepipeline-stack.yaml`ï¼‰
5. **æµ‹è¯•éƒ¨ç½²æµç¨‹**
6. **ç›‘æ§é¦–æ¬¡éƒ¨ç½²**

---

## ğŸ“š ç›¸å…³èµ„æº

- [AWS CodePipeline æ–‡æ¡£](https://docs.aws.amazon.com/codepipeline/)
- [AWS CodeBuild æ–‡æ¡£](https://docs.aws.amazon.com/codebuild/)
- [Serverless Framework æ–‡æ¡£](https://www.serverless.com/framework/docs)
- [AWS Secrets Manager æ–‡æ¡£](https://docs.aws.amazon.com/secretsmanager/)

---

## âœ… æ€»ç»“

**æ€»ä½“è¯„åˆ†**: 8/10

**ä¼˜ç‚¹**:
- æ¶æ„è®¾è®¡åˆç†
- é…ç½®åŸºæœ¬å®Œæ•´
- å®‰å…¨æ€§è€ƒè™‘åˆ°ä½

**éœ€è¦æ”¹è¿›**:
- Handler è·¯å¾„é…ç½®
- é…ç½®ä¸€è‡´æ€§
- Layer æ„å»ºæµç¨‹

**å»ºè®®**: ä¿®å¤ä¸Šè¿°é—®é¢˜åï¼Œè¿™æ˜¯ä¸€ä¸ª**ç”Ÿäº§å°±ç»ª**çš„éƒ¨ç½²æ–¹æ¡ˆã€‚

---

**æœ€åæ›´æ–°**: 2025-11-04

