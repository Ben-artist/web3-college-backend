name: Deploy to AWS EC2

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # AIä»£ç å®¡æŸ¥
  ai-code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install

      - name: AI Code Review
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_TYPESCRIPT_ES: false
          VALIDATE_JAVASCRIPT_ES: false
          # ç¦ç”¨ESLintï¼Œä½¿ç”¨Biome
          DISABLE_ERRORS: true

      - name: AI Code Review with Claude
        uses: anthropic-ai/claude-action@v1
        with:
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            è¯·å®¡æŸ¥è¿™ä¸ªTypeScript/NestJSé¡¹ç›®çš„ä»£ç å˜æ›´ï¼Œé‡ç‚¹å…³æ³¨ï¼š
            1. ä»£ç è´¨é‡å’Œæœ€ä½³å®è·µ
            2. å®‰å…¨æ€§é—®é¢˜
            3. æ€§èƒ½ä¼˜åŒ–å»ºè®®
            4. é”™è¯¯å¤„ç†
            5. ç±»å‹å®‰å…¨
            6. ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§

            è¯·æä¾›å…·ä½“çš„æ”¹è¿›å»ºè®®å’Œä»£ç ç¤ºä¾‹ã€‚

  # ä»£ç æ ¼å¼åŒ–å’Œæ£€æŸ¥
  code-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install

      - name: Run Biome check
        run: pnpm biome check .

      - name: Run Biome format
        run: pnpm biome format --write .

      - name: Commit formatted code
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "ğŸ¤– Auto-format code with Biome"
          git push

  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    runs-on: ubuntu-latest
    needs: [code-format]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install

      - name: Run Biome check
        run: pnpm biome check .

      - name: Build application
        run: pnpm build

      - name: Run tests
        run: pnpm test --coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  # éƒ¨ç½²åˆ°AWS EC2
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install

      - name: Build application
        run: pnpm build

      - name: Create deployment package
        run: |
          tar -czf deployment.tar.gz dist/ package.json pnpm-lock.yaml

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            # åœæ­¢åº”ç”¨
            sudo systemctl stop web3-university-api || true

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "/opt/web3-university-api" ]; then
              sudo mv /opt/web3-university-api /opt/web3-university-api.backup.$(date +%Y%m%d_%H%M%S)
            fi

            # åˆ›å»ºæ–°ç›®å½•
            sudo mkdir -p /opt/web3-university-api
            sudo chown $USER:$USER /opt/web3-university-api

      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          source: 'deployment.tar.gz'
          target: '/opt/web3-university-api/'

      - name: Extract and setup on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            cd /opt/web3-university-api

            # è§£å‹æ–‡ä»¶
            tar -xzf deployment.tar.gz
            rm deployment.tar.gz

            # å®‰è£…ä¾èµ–
            pnpm install --prod

            # è®¾ç½®ç¯å¢ƒå˜é‡
            sudo cp .env.production /opt/web3-university-api/.env

            # é‡å¯åº”ç”¨
            sudo systemctl start web3-university-api
            sudo systemctl enable web3-university-api

            # å¥åº·æ£€æŸ¥
            sleep 10
            curl -f http://localhost:4000/api/health || exit 1

            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"

  # é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Notify deployment status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
