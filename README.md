# Web3å¤§å­¦åç«¯APIæ¥å£æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

Web3å¤§å­¦æ˜¯ä¸€ä¸ªå®Œå…¨å»ä¸­å¿ƒåŒ–çš„Web3æ•™è‚²å¹³å°ï¼ŒåŸºäºåŒºå—é“¾æŠ€æœ¯æ„å»ºã€‚ç”¨æˆ·é€šè¿‡Web3é’±åŒ…ç™»å½•ï¼Œä½¿ç”¨YDå¸æ”¯ä»˜è¯¾ç¨‹è´¹ç”¨ï¼Œè·å¾—NFTè¯ä¹¦ã€‚æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨Storacha IPFSä¸Šï¼Œè¯¾ç¨‹å’Œè¯ä¹¦éƒ½é€šè¿‡æ™ºèƒ½åˆçº¦ç®¡ç†ï¼Œå®ç°çœŸæ­£çš„å»ä¸­å¿ƒåŒ–æ•™è‚²ã€‚

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: NestJS
- **æ•°æ®åº“**: PostgreSQL + TypeORM
- **åŒ…ç®¡ç†å™¨**: pnpm
- **APIæ–‡æ¡£**: Swagger
- **è®¤è¯**: Web3é’±åŒ…ç­¾åéªŒè¯
- **åŒºå—é“¾**: Ethereum
- **å­˜å‚¨**: Storacha IPFS (å»ä¸­å¿ƒåŒ–å­˜å‚¨)
- **æ”¯ä»˜**: YDå¸
- **è¯ä¹¦**: NFT (ERC-721)
- **Web3åº“**: wagmi (React Hooks for Ethereum)

## é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ user/           # ç”¨æˆ·ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ auth/           # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ course/         # è¯¾ç¨‹ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ lesson/         # è¯¾æ—¶ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ storage/        # Web3å­˜å‚¨æ¨¡å—
â”‚   â”œâ”€â”€ certificate/    # NFTè¯ä¹¦æ¨¡å—
â”‚   â”œâ”€â”€ payment/        # YDå¸æ”¯ä»˜æ¨¡å—
â”‚   â”œâ”€â”€ notification/   # é€šçŸ¥æ¨¡å—
â”‚   â”œâ”€â”€ community/      # ç¤¾åŒºæ¨¡å—
â”‚   â””â”€â”€ admin/          # ç®¡ç†å‘˜æ¨¡å—
```

## å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½

1. âœ… ç”¨æˆ·ç®¡ç†æ¨¡å—
2. ğŸ”„ è®¤è¯æ¨¡å—
3. ğŸ“‹ è¯¾ç¨‹ç®¡ç†æ¨¡å—
4. ğŸ“‹ è¯¾æ—¶ç®¡ç†æ¨¡å—
5. ğŸ“‹ Web3å­˜å‚¨æ¨¡å—

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½

1. ğŸ“‹ NFTè¯ä¹¦æ¨¡å—
2. ğŸ“‹ YDå¸æ”¯ä»˜æ¨¡å—
3. ğŸ“‹ é€šçŸ¥æ¨¡å—

### ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½

1. ğŸ“‹ ç¤¾åŒºæ¨¡å—
2. ğŸ“‹ ç®¡ç†å‘˜æ¨¡å—

## æœ¬åœ°å¼€å‘è¯´æ˜

### ç¯å¢ƒè¦æ±‚

- Node.js 18+
- PostgreSQL 13+
- pnpm

### å®‰è£…ä¾èµ–

```bash
pnpm install
```

### ç¯å¢ƒé…ç½®

å¤åˆ¶ `env.example` åˆ° `.env` å¹¶é…ç½®ï¼š

```env
# Supabaseé…ç½®
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
SUPABASE_DB_PASSWORD=your_supabase_db_password

# ç­¾åéªŒè¯é…ç½®
SIGNATURE_TIMEOUT=300000 # 5åˆ†é’Ÿç­¾åæœ‰æ•ˆæœŸï¼ˆæ¯«ç§’ï¼‰

# IPFSå­˜å‚¨é…ç½®
# é€‰æ‹©å­˜å‚¨æ–¹å¼ï¼šsimple (å…è´¹) æˆ– storacha (éœ€è¦é’±åŒ…è®¤è¯)
STORAGE_TYPE=simple
IPFS_GATEWAY=https://ipfs.io
STORACHA_GATEWAY=https://w3s.link

# YDå¸åˆçº¦é…ç½®
YD_TOKEN_CONTRACT=0x... # YDå¸åˆçº¦åœ°å€
ETHEREUM_RPC_URL=https://mainnet.infura.io/v3/your_project_id

# NFTè¯ä¹¦åˆçº¦é…ç½®
NFT_CERTIFICATE_CONTRACT=0x... # NFTè¯ä¹¦åˆçº¦åœ°å€
```

### å¦‚æœæƒ³ä½¿ç”¨docker

docker-compose up -d
**ä½¿ç”¨ Docker å¯åŠ¨ PostgreSQL æœåŠ¡ï¼š**
**PostgreSQLï¼ˆç«¯å£ï¼š5432ï¼‰**
**æ•°æ®å°†æŒä¹…åŒ–å­˜å‚¨åœ¨ `localStoreData/` ç›®å½•ä¸‹ã€‚**

### è¿è¡Œé¡¹ç›®

```bash
# å¼€å‘æ¨¡å¼
pnpm run dev

# ç”Ÿäº§æ¨¡å¼
pnpm run build
pnpm run start:prod
```

### éƒ¨ç½²è¯´æ˜

é¡¹ç›®ä½¿ç”¨Supabaseä½œä¸ºæ•°æ®åº“æœåŠ¡ï¼š

1. **Supabaseéƒ¨ç½²**ï¼šä½¿ç”¨Supabaseä½œä¸ºåç«¯æœåŠ¡ï¼Œæ”¯æŒè‡ªåŠ¨æ‰©å±•å’Œå…¨çƒCDN
2. **Dockeréƒ¨ç½²**ï¼šä½¿ç”¨Docker Composeè¿›è¡Œå®¹å™¨åŒ–éƒ¨ç½²ï¼ˆä»…ç”¨äºPostgreSQLç­‰è¾…åŠ©æœåŠ¡ï¼‰
3. **ä¼ ç»ŸæœåŠ¡å™¨éƒ¨ç½²**ï¼šåœ¨Linux/WindowsæœåŠ¡å™¨ä¸Šç›´æ¥è¿è¡Œ
4. **äº‘æœåŠ¡éƒ¨ç½²**ï¼šæ”¯æŒå„å¤§äº‘æœåŠ¡å•†çš„æ ‡å‡†éƒ¨ç½²æ–¹å¼

#### Supabaseéƒ¨ç½²ä¼˜åŠ¿

- ğŸš€ **å¿«é€Ÿéƒ¨ç½²**ï¼šå‡ åˆ†é’Ÿå†…å®Œæˆæ•°æ®åº“å’ŒAPIéƒ¨ç½²
- ğŸŒ **å…¨çƒCDN**ï¼šè‡ªåŠ¨å…¨çƒå†…å®¹åˆ†å‘ï¼Œä½å»¶è¿Ÿè®¿é—®
- ğŸ“Š **å®æ—¶ç›‘æ§**ï¼šå†…ç½®æ€§èƒ½ç›‘æ§å’Œé”™è¯¯è¿½è¸ª
- ğŸ”’ **å®‰å…¨å¯é **ï¼šä¼ä¸šçº§å®‰å…¨é˜²æŠ¤å’Œè‡ªåŠ¨å¤‡ä»½
- ğŸ’° **æˆæœ¬æ•ˆç›Š**ï¼šå…è´¹é¢åº¦å……è¶³ï¼ŒæŒ‰éœ€ä»˜è´¹
- ğŸ”§ **æ˜“äºç»´æŠ¤**ï¼šè‡ªåŠ¨æ›´æ–°å’Œç»´æŠ¤ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†

## APIæ¥å£è®¾è®¡

[é¡¹ç›®è®¾è®¡æ–‡æ¡£](./project-design.md)

### APIæ–‡æ¡£

å¯åŠ¨é¡¹ç›®åè®¿é—®ï¼š`http://localhost:3000/api` æŸ¥çœ‹Swagger APIæ–‡æ¡£

## æ³¨æ„äº‹é¡¹

1. **Web3å®‰å…¨æ€§**ï¼šæ‰€æœ‰APIéƒ½éœ€è¦é’±åŒ…ç­¾åéªŒè¯ï¼Œç¡®ä¿å»ä¸­å¿ƒåŒ–å®‰å…¨
2. **æ•°æ®éªŒè¯**ï¼šä½¿ç”¨class-validatorè¿›è¡Œè¯·æ±‚æ•°æ®éªŒè¯
3. **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
4. **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ‰€æœ‰é‡è¦æ“ä½œå’ŒåŒºå—é“¾äº¤æ˜“
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨æ•°æ®åº“ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–
6. **åŒºå—é“¾é›†æˆ**ï¼š
   - æ”¯æŒYDå¸æ”¯ä»˜
   - NFTè¯ä¹¦é“¸é€ å’Œç®¡ç†
   - Storacha IPFSå»ä¸­å¿ƒåŒ–å­˜å‚¨
   - æ™ºèƒ½åˆçº¦äº¤äº’
7. **å»ä¸­å¿ƒåŒ–ç‰¹æ€§**ï¼š
   - ç”¨æˆ·é€šè¿‡é’±åŒ…åœ°å€æ ‡è¯†
   - æ‰€æœ‰é‡è¦æ•°æ®ä¸Šé“¾å­˜å‚¨
   - æ”¯æŒNFTè¯ä¹¦è½¬ç§»å’Œäº¤æ˜“
   - è¯¾ç¨‹å†…å®¹å­˜å‚¨åœ¨Storacha IPFS
8. **Gasè´¹ä¼˜åŒ–**ï¼šåˆç†è®¾è®¡æ™ºèƒ½åˆçº¦ï¼Œå‡å°‘Gasæ¶ˆè€—
9. **å¤šé“¾æ”¯æŒ**ï¼šåç»­å¯æ‰©å±•æ”¯æŒPolygonã€BSCç­‰é“¾
10. **çµæ´»éƒ¨ç½²**ï¼šæ”¯æŒDockerã€ä¼ ç»ŸæœåŠ¡å™¨ã€äº‘æœåŠ¡ç­‰å¤šç§éƒ¨ç½²æ–¹å¼

## å®ä½“è®¾è®¡åˆ†ææŠ¥å‘Š

### ğŸ“Š åŸå§‹å®ä½“è®¾è®¡é—®é¢˜åˆ†æ

#### âŒ ä¸»è¦é—®é¢˜

1. **ç¼ºå°‘Web3æ ¸å¿ƒå­—æ®µ**ï¼šåŸå§‹è®¾è®¡ç¼ºå°‘`walletAddress`ç­‰Web3å»ä¸­å¿ƒåŒ–å¹³å°å¿…éœ€å­—æ®µ
2. **å®ä½“å…³ç³»ä¸å®Œæ•´**ï¼šç¼ºå°‘NFTè¯ä¹¦ã€æ”¯ä»˜è®°å½•ã€å­¦ä¹ è¿›åº¦ç­‰æ ¸å¿ƒå®ä½“
3. **å­—æ®µè®¾è®¡ä¸ç¬¦åˆWeb3ç‰¹æ€§**ï¼šç¼ºå°‘ä»·æ ¼ã€åˆ†ç±»ã€IPFSå­˜å‚¨ç­‰å­—æ®µ
4. **æ•°æ®ç±»å‹é€‰æ‹©ä¸å½“**ï¼šä»·æ ¼å­—æ®µåº”ä½¿ç”¨å­—ç¬¦ä¸²å­˜å‚¨å¤§æ•°

#### âœ… æ”¹è¿›åçš„å®ä½“è®¾è®¡

### ğŸ—ï¸ æ ¸å¿ƒå®ä½“ç»“æ„

#### 1. Userå®ä½“ï¼ˆç”¨æˆ·ï¼‰

```typescript
- walletAddress: string (ä¸»è¦æ ‡è¯†ç¬¦)
- username: string
- email?: string
- role: 'student' | 'instructor' | 'admin'
- isVerified: boolean
- nonce?: string (ç­¾åéªŒè¯)
- å­¦ä¹ ç»Ÿè®¡å­—æ®µ
```

#### 2. Teacherå®ä½“ï¼ˆè®²å¸ˆï¼‰

```typescript
- walletAddress: string
- specializations?: string[]
- level: 'junior' | 'senior' | 'expert'
- rating: number
- socialLinks?: object
```

#### 3. Courseå®ä½“ï¼ˆè¯¾ç¨‹ï¼‰

```typescript
- instructorWallet: string
- category: string
- level: 'beginner' | 'intermediate' | 'advanced'
- price: string (YDå¸ä»·æ ¼)
- priceInUSD: number
- nftContract?: string
- resources?: object
```

#### 4. Lessonå®ä½“ï¼ˆè¯¾æ—¶ï¼‰

```typescript
- courseId: number
- videoUrl?: string (IPFSé“¾æ¥)
- videoCid?: string
- type: 'video' | 'text' | 'quiz' | 'assignment'
- status: 'draft' | 'published' | 'archived'
```

#### 5. NFTCertificateå®ä½“ï¼ˆNFTè¯ä¹¦ï¼‰

```typescript
- tokenId: string
- contractAddress: string
- walletAddress: string
- metadata: string (IPFSé“¾æ¥)
- image: string (IPFSé“¾æ¥)
- transactionHash: string
```

#### 6. Paymentå®ä½“ï¼ˆæ”¯ä»˜è®°å½•ï¼‰

```typescript
- courseId: number
- walletAddress: string
- amount: string (YDå¸æ•°é‡)
- transactionHash: string
- status: 'pending' | 'confirmed' | 'failed' | 'refunded'
```

#### 7. UserCourseFavoriteå®ä½“ï¼ˆç”¨æˆ·è¯¾ç¨‹æ”¶è—ï¼‰

```typescript
- userId: number
- courseId: number
- user: User (å…³è”ç”¨æˆ·)
- course: Course (å…³è”è¯¾ç¨‹)
- notes?: string (ç”¨æˆ·å¤‡æ³¨)
```

#### 8. UserCoursePurchaseå®ä½“ï¼ˆç”¨æˆ·è¯¾ç¨‹è´­ä¹°è®°å½•ï¼‰

```typescript
- userId: number
- courseId: number
- user: User (å…³è”ç”¨æˆ·)
- course: Course (å…³è”è¯¾ç¨‹)
- amount: string (æ”¯ä»˜é‡‘é¢ï¼ŒYDå¸)
- status: 'pending' | 'confirmed' | 'failed' | 'refunded'
- transactionHash?: string (åŒºå—é“¾äº¤æ˜“å“ˆå¸Œ)
- paidAt?: Date (æ”¯ä»˜æ—¶é—´)
- refundedAt?: Date (é€€æ¬¾æ—¶é—´)
- refundTransactionHash?: string (é€€æ¬¾äº¤æ˜“å“ˆå¸Œ)
```

#### 9. LearningProgresså®ä½“ï¼ˆå­¦ä¹ è¿›åº¦ï¼‰

```typescript
- walletAddress: string
- courseId: number
- lessonId: number
- status: 'not_started' | 'in_progress' | 'completed'
- completionPercentage: number
```

#### 10. Notificationå®ä½“ï¼ˆé€šçŸ¥ï¼‰

```typescript
- walletAddress: string
- type: 'course_update' | 'payment_success' | 'certificate_minted'
- priority: 'low' | 'medium' | 'high' | 'urgent'
- isRead: boolean
```

### ğŸ”— å®ä½“å…³ç³»è®¾è®¡

```
User (1) â†â†’ (N) Course (ä½œä¸ºè®²å¸ˆ)
User (1) â†â†’ (N) UserCourseFavorite (æ”¶è—è¯¾ç¨‹)
User (1) â†â†’ (N) UserCoursePurchase (è´­ä¹°è¯¾ç¨‹)
User (1) â†â†’ (N) UserCourseProgress (å­¦ä¹ è¿›åº¦)
User (1) â†â†’ (N) NFTCertificate
User (1) â†â†’ (N) Notification

Course (1) â†â†’ (N) Chapter
Course (1) â†â†’ (N) UserCourseFavorite
Course (1) â†â†’ (N) UserCoursePurchase
Course (1) â†â†’ (N) UserCourseProgress
Course (1) â†â†’ (N) NFTCertificate
```

### ğŸ“ è®¾è®¡å†³ç­–è¯´æ˜

#### ä¸ºä»€ä¹ˆéœ€è¦å•ç‹¬çš„æ”¶è—å’Œè´­ä¹°è¡¨ï¼Ÿ

1. **åŠŸèƒ½åˆ†ç¦»**ï¼šæ”¶è—å’Œè´­ä¹°æ˜¯ä¸¤ä¸ªä¸åŒçš„ä¸šåŠ¡åŠŸèƒ½ï¼Œéœ€è¦ç‹¬ç«‹ç®¡ç†
2. **æ•°æ®å®Œæ•´æ€§**ï¼šè´­ä¹°è®°å½•éœ€è¦åŒ…å«æ”¯ä»˜ä¿¡æ¯ã€äº¤æ˜“å“ˆå¸Œç­‰åŒºå—é“¾ç›¸å…³æ•°æ®
3. **æŸ¥è¯¢ä¼˜åŒ–**ï¼šå¯ä»¥ç‹¬ç«‹æŸ¥è¯¢ç”¨æˆ·çš„æ”¶è—åˆ—è¡¨å’Œè´­ä¹°è®°å½•ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
4. **ä¸šåŠ¡é€»è¾‘æ¸…æ™°**ï¼šæ”¶è—å¯ä»¥éšæ—¶å–æ¶ˆï¼Œè´­ä¹°è®°å½•éœ€è¦æ°¸ä¹…ä¿å­˜
5. **æ‰©å±•æ€§**ï¼šæœªæ¥å¯ä»¥è½»æ¾æ·»åŠ æ”¶è—å¤¹åˆ†ç±»ã€è´­ä¹°å†å²åˆ†æç­‰åŠŸèƒ½

#### ä¸ºä»€ä¹ˆä¸éœ€è¦Teacher_Courseå…³è”è¡¨ï¼Ÿ

1. **ä¸€å¯¹ä¸€å…³ç³»**ï¼šæ¯ä¸ªè¯¾ç¨‹åªæœ‰ä¸€ä¸ªä¸»è¦è®²å¸ˆ
2. **ç®€åŒ–æŸ¥è¯¢**ï¼šç›´æ¥åœ¨Courseè¡¨ä¸­å­˜å‚¨è®²å¸ˆä¿¡æ¯ï¼Œé¿å…JOINæŸ¥è¯¢
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢å¤æ‚åº¦
4. **Web3ç‰¹æ€§**ï¼šé’±åŒ…åœ°å€ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œæ— éœ€é¢å¤–å…³è”
5. **æ•°æ®å†—ä½™åˆç†**ï¼šè®²å¸ˆå§“åå’Œå¤´åƒåœ¨Courseè¡¨ä¸­å†—ä½™å­˜å‚¨ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡

### ğŸ¯ è®¾è®¡ä¼˜åŠ¿

1. **Web3åŸç”Ÿæ”¯æŒ**ï¼šæ‰€æœ‰å®ä½“éƒ½æ”¯æŒé’±åŒ…åœ°å€ä½œä¸ºä¸»è¦æ ‡è¯†ç¬¦
2. **å»ä¸­å¿ƒåŒ–å­˜å‚¨**ï¼šä½¿ç”¨IPFSé“¾æ¥å­˜å‚¨è§†é¢‘ã€å›¾ç‰‡ç­‰èµ„æº
3. **åŒºå—é“¾é›†æˆ**ï¼šæ”¯æŒNFTè¯ä¹¦ã€YDå¸æ”¯ä»˜ç­‰åŒºå—é“¾åŠŸèƒ½
4. **å®Œæ•´çš„å­¦ä¹ æµç¨‹**ï¼šä»è¯¾ç¨‹è´­ä¹°åˆ°è¯ä¹¦è·å¾—çš„å®Œæ•´é“¾è·¯
5. **çµæ´»çš„æƒé™ç®¡ç†**ï¼šæ”¯æŒå¤šè§’è‰²å’Œæƒé™æ§åˆ¶
6. **æ•°æ®å®Œæ•´æ€§**ï¼šä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹å’Œçº¦æŸ

## æ›´æ–°æ—¥å¿—

### v1.3.0 (2024-01-15)

- âœ… é›†æˆSupabaseæ•°æ®åº“æ”¯æŒ
- âœ… æ·»åŠ SupabaseæœåŠ¡æ¨¡å—å’Œé…ç½®
- âœ… åˆ›å»ºå®Œæ•´çš„æ•°æ®åº“è¿ç§»è„šæœ¬
- âœ… å®Œå…¨ä½¿ç”¨Supabaseä½œä¸ºæ•°æ®åº“æœåŠ¡
- âœ… æ·»åŠ Supabaseéƒ¨ç½²æŒ‡å—å’Œæœ€ä½³å®è·µ

### v1.2.0 (2024-01-15)

- âœ… ç§»é™¤æ‰€æœ‰Vercelç›¸å…³é…ç½®å’Œä»£ç 
- âœ… ç®€åŒ–åº”ç”¨ç¨‹åºå¯åŠ¨æµç¨‹
- âœ… ç»Ÿä¸€æ—¥å¿—é…ç½®ï¼Œæ”¯æŒæœ¬åœ°æ–‡ä»¶æ—¥å¿—
- âœ… ä¼˜åŒ–Swaggeræ–‡æ¡£é…ç½®

### v1.1.0 (2024-01-15)

- âœ… é‡æ–°è®¾è®¡æ‰€æœ‰å®ä½“ç»“æ„
- âœ… æ·»åŠ Web3å»ä¸­å¿ƒåŒ–ç‰¹æ€§æ”¯æŒ
- âœ… å®Œå–„å®ä½“é—´å…³ç³»è®¾è®¡
- âœ… æ·»åŠ NFTè¯ä¹¦ã€æ”¯ä»˜ã€å­¦ä¹ è¿›åº¦ç­‰æ ¸å¿ƒå®ä½“
- âœ… ä¼˜åŒ–æ•°æ®ç±»å‹å’Œå­—æ®µè®¾è®¡

### v1.0.0 (2024-01-15)

- åˆå§‹é¡¹ç›®ç»“æ„
- ç”¨æˆ·ç®¡ç†æ¨¡å—åŸºç¡€åŠŸèƒ½
- APIæ¥å£è®¾è®¡æ–‡æ¡£

---

_æ­¤æ–‡æ¡£å°†æ ¹æ®é¡¹ç›®å¼€å‘è¿›åº¦æŒç»­æ›´æ–°_
